name: Java Selenium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    name: Run Selenium Tests
    runs-on: ubuntu-latest

    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            unzip \
            curl \
            libxss1 \
            fonts-liberation \
            libnss3 \
            libnspr4 \
            libdbus-1-3 \
            libatk-bridge2.0-0 \
            libgtk-3-0 \
            libx11-xcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            xvfb

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Google Chrome
      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          echo "âœ… Chrome version: $(google-chrome --version)"

      # Ð¨Ð°Ð³ 4: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Ð¨Ð°Ð³ 5: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Allure
      - name: Install Allure
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.tgz
          tar -zxvf allure-2.29.0.tgz -C /opt/
          ln -s /opt/allure-2.29.0/bin/allure /usr/local/bin/allure
          echo "âœ… Allure version: $(allure --version)"

      # Ð¨Ð°Ð³ 6: Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ gradlew
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Ð¨Ð°Ð³ 7: Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Xvfb
      - name: Run tests with Xvfb
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          ./gradlew clean test --info --stacktrace
        env:
          selenide.browser: chrome
          selenide.headless: true

      # Ð¨Ð°Ð³ 8: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Allure Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
      - name: Generate Allure Report
        run: |
          allure generate build/allure-results -o build/reports/allure-report -c
          echo "âœ… Allure report generated"

      # Ð¨Ð°Ð³ 9: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ README Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
      - name: Create report info
        run: |
          cat > build/reports/allure-report/README.md << 'EOF'
          # Allure Test Report
          
          ## ÐšÐ°Ðº Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚:
          
          ### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: ÐžÐ½Ð»Ð°Ð¹Ð½ (GitHub Pages)
          ÐžÑ‚Ñ‡ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐµÑ‚ÑÑ Ð½Ð° GitHub Pages.
          
          ### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
          1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ `allure-report-download` Ð¸Ð· GitHub Actions
          2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð²
          3. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» `index.html` Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ
          
          ## Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐµ:
          - **Ð ÐµÐ²Ð¸Ð·Ð¸Ñ:** ${{ github.sha }}
          - **Ð’ÐµÑ‚ÐºÐ°:** ${{ github.ref_name }}
          - **Ð—Ð°Ð¿ÑƒÑÐº:** #${{ github.run_number }}
          EOF

      # Ð¨Ð°Ð³ 10: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ
      - name: Upload Allure report as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-download
          path: build/reports/allure-report/
          retention-days: 30

      - name: Upload test results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-download
          path: |
            build/test-results/
            build/allure-results/
          retention-days: 30

      # Ð¨Ð°Ð³ 11: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð½Ð° GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: success()

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        if: success()
        with:
          path: ./build/reports/allure-report

      - name: Deploy to GitHub Pages
        if: success()
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ job Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
  notify:
    name: Report Notification
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Report Success
        if: needs.test.result == 'success'
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ðŸ”— Allure Report URL: $REPORT_URL"
          echo "::notice title=Allure Report::$REPORT_URL"
          echo "ðŸŽ‰ Ð¢ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
          echo "ðŸ“Š Allure Report Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½:"
          echo "   ðŸ’¾ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ: Ð’ Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ Artifacts ÐºÐ°Ðº 'allure-report-download'"
          echo "   ðŸŒ ÐžÐ½Ð»Ð°Ð¹Ð½: ÐŸÐ¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ GitHub Pages"

      - name: Report Failure
        if: needs.test.result == 'failure'
        run: |
          echo "âŒ Ð¢ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð¸ÑÑŒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ð¼Ð¸"
          echo "ðŸ“‹ ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ Artifacts ÐºÐ°Ðº 'test-results-download'"